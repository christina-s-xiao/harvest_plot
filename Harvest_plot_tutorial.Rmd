---
title: "Creating Harvest Plots in R"
author: "Christina Xiao and Richard Patterson"
date: "2023-04-05"
output:
  prettydoc::html_pretty:
    theme: cayman
    toc: true
---

***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Visualisations are an important way for systematic reviews identify and demonstrate patterns in the reviewed literature. These are often more efficient and effective than using text, especially where meta-analysis is not possible [(Cochrane Handbook)](https://training.cochrane.org/handbook/current/chapter-12#section-12-3). Harvest plots are one way to do this, they have been defined by [Ogilvie et al., 2009](https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-8-8) as:
<br>

>A novel and useful method for synthesising evidence about the differential effects of population-level interventions. It contributes to the challenge of making best use of all available evidence by incorporating all relevant data. The visual display assists both the process of synthesis and the assimilation of the findings. The method is suitable for adaptation to a variety of questions in evidence synthesis and may be particularly useful for systematic reviews addressing the broader type of research question which may be most relevant to policymakers.

<br>

We aim to demonstrate how to create a simple harvest plot using R and how this can be extended where there are multiple outcomes and exposures of interest. Our examples come from "Shifting towards healthier transport: carrots or sticks? Systematic review and meta-analysis of population-level interventions" [Xiao et al., 2022](https://www.thelancet.com/journals/lanplh/article/PIIS2542-5196(22)00220-0/fulltext). This study aimed to compare the effectiveness of carrot, stick, and combined carrot-and-stick interventions in changing different transport behaviors. 
<br><br>

With this in mind, let's get plotting!

<br><br>

***

# Setup

## Load R Packages
Load the relevant packages:
```{r message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)
library(knitr)
library(ggpubr)
```
<br><br>

***

## Load data

We first start using the following dataset to create our simple version of the harvest plot.
```{r message=FALSE, warning=FALSE}
df = tibble(
  direction_effect = factor(c("Decrease", "Decrease", "Decrease", "Decrease", "Decrease",
                   "Decrease", "Decrease", "Decrease", "Decrease", "Decrease",
                   "Decrease", "Decrease", "Decrease", "Decrease", "Decrease",
                   "Decrease", "Decrease", "Decrease", "Decrease", "Decrease",
                   "No change","No change","No change","No change","No change",
                   "No change", "Increase", "Increase", "Increase", "Increase",
                   "Increase", "Increase", "Increase", "Increase"),
                   levels = c("Decrease", "No change", "Increase")) ,
  stat_sig = factor(c("Yes","No","No","No","Yes","Yes","No","Yes","N/A","N/A","N/A",
               "N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","No","N/A",
               "No","No","N/A","N/A","N/A","No","Yes","Yes","No","N/A","N/A","No"), 
               levels = c("Yes", "No", "N/A")),
  quality = factor(c("high","high","high","high","moderate","moderate","moderate",
              "moderate","low","low","low","low","low","low","low","low","low",
              "low","low","low","moderate","low","low","low","low","low","low","high",
              "moderate","moderate","low","moderate","low","low"), 
              levels = c("low", "moderate", "high")),
  n_interventions = c(1,1,1,2,3,3,4,1,1,1,1,1,1,1,1,1,1,2,2,1,4,1,1,1,1,1,1,4,2,2,1,1,2,1),
  position = c(1,3,4,2,5,6,8,7,11,12,13,14,15,16,17,18,19,9,10,20,10,11,9,8,12,13,13,20,19,
               18,16,17,14,15))
df$quality = as.numeric(df$quality)

```

And this is what the data frame looks like:
```{r}
knitr::kable(head(df))
```

<br><br>

***

### Defining variables 

The following defines each variable in the simplified harvest plot dataset:

- **position**: (Numeric) Placement of the individual study outcome in the harvest plot <br>
- **direction_effect**: (Factor) Whether there was an increase, decrease, or no change in the outcome. <br>
- **stat_sig**: (Factor) Whether the difference was found to be statistically significant. This will be represented by the shading of the bars <br>
- **quality**: (Numeric) Indicates the study quality. We have three categories here: low, moderate, and high, which was converted into a numeric variable (1 = low, 2 = moderate, 3 = high). This will be represented by the height of the bars<br>
- **n_interventions**: (Numeric) The number of intervention components, as represented by a number above each bar<br>
<br><br>

***


# Setting the position of bars representing each study

In the basic example above we manually set the position of the bars, using the variable **position**. Bars are positioned at the extremities of the facets (for decrease and increase) or in the middle (for no change). Within each facet, the bars are sorted by the characteristics plotted, in order of precedence. In this case bars were sorted by study quality, significant and number of intervention components. It is usual to sort initially by the same characteristic used to determine bar height.

This variable can be set manually as we did above, alternatively a function is provided below which might be useful.

```{r}
df = df %>%
  group_by(direction_effect) %>%
  arrange(desc(quality), stat_sig, desc(n_interventions), .by_group = TRUE)


c = count(df, direction_effect, .drop = TRUE)

n = max(c$n)

for(i in 1:n){
  
  if(i == 1){
    v = vector()
    v[i] = floor(n/2)
  }else{
    if((i %% 2) == 0){
      v[i] = v[i-1] + i-1
    }else{
      v[i] = v[i-1] -i+1
    }
  }
  rm(i)
}

decrease_ord = as.vector(1:n)
no_change_ord = v
increase_ord = as.vector(n:1)


l = list()
for(i in 1:nrow(c)){
  
  if(c$direction_effect[i]=="Decrease"){
    l[[i]] = decrease_ord[1:c$n[i]]
  }
  
  if(c$direction_effect[i]=="No change"){
    l[[i]] = no_change_ord[1:c$n[i]]
  }
  
  if(c$direction_effect[i]=="Increase"){
    l[[i]] = increase_ord[1:c$n[i]]
  }
}

l = l[!c$n==0]
df$position = unlist(l)

```
***

# Basic Harvest plot

The data allow us to visualise the evidence to support a change in travel mode as a result of an intervention, in addition to several additional characteristics of the studies and their outcomes. Initially we create a plot that conveys the relative evidence for a decrease, increase or no change in travel, along with the study quality.

```{r, fig.width=10,fig.height=3, warning=FALSE}
ggplot(df, aes(y=quality, x=position)) + geom_bar(stat="identity") +
  facet_grid(cols = vars(direction_effect)) 
```

Using the facet_grid option we disaggregate the studies based on their outcomes, allowing us to see the amount of studies supporting each finding. The height of the bars indicates study quality facilitate a comparison of the strength of evidence for each finding. 

We can add further data about the study or its findings to better visualise the nature of the evidence base.

To set the colour scheme:
```{r}
cbPalette <- c("#264653","#2a9d8f","#f4a261")
```

Plotting the figure with colours and labels to further differentiate between studies:
```{r, fig.width=10,fig.height=3, warning=FALSE}
ggplot(df, aes(y=quality, x=position, fill = stat_sig)) + geom_bar(stat="identity") +
  facet_grid(cols = vars(direction_effect)) + scale_fill_manual(values=cbPalette) +
  guides(fill = guide_legend("Significant")) +
  geom_text(aes(label=n_interventions), position=position_dodge(width=0.9), vjust=-0.4)
```

We can now see the statistical significance of the findings for each study (colour) and the number of intervention components (number about the bars). The most important characteristics will likely differ depending on the specific research question being addressed and reviewers can tailor the Harvest plots to their needs.

** we could include a prettier version without the grey background etc. or maybe save that for the more complete plot.**
```{r, fig.width=10,fig.height=3, warning=FALSE}
ggplot(df, aes(y=quality, x=position, fill = stat_sig)) + geom_bar(stat="identity") +
  facet_grid(cols = vars(direction_effect)) + scale_fill_manual(values=cbPalette) +
  guides(fill = guide_legend("Significant")) +
  geom_text(aes(label=n_interventions), position=position_dodge(width=0.9), vjust=-0.4) +  
  theme(strip.placement = "outside")+ scale_y_continuous("", limits=c(0,3.5)) +
  theme_minimal(base_size = 12) +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank())
```

***



# Including more exposures

If you have a dataset with more than one outcome and exposure, the following section provides guidance on how to create a harvest plot that would allow you to compare multiple outcomes and exposures.

## Loading data
First, we load the data:
```{r}
data_harvest <- readRDS(url("https://github.com/christina-s-xiao/harvest_plot/raw/revise/harvest_plot_data.rds"))
```

And this is what the new loaded dataset looks like:
```{r}
knitr::kable(head(data_harvest))
```
<br><br>
Here, we have a few more variables, as defined below:

- **study_id**: Unique study identifier <br>
- **outcome_mode**: Outcome of interest in your review. This can be a single outcome or many. Here, we are interested in looking at driving and public transport <br>
- **cs_category**: Exposure or category of studies to be compared, which will be placed in separate rows<br>
<br><br>


## Creating separate plots for each outcome

First, we will plot the harvest plot for driving outcomes, which we will later combine with the public transport outcomes in a separate figure. To do so, we create two new datasets called 'drive' and 'public_transport'.

```{r}
drive <- data_harvest[data_harvest$outcome_mode == 'Driving', ]
public_transport <- data_harvest[data_harvest$outcome_mode == 'Public transport', ]
```


### Driving harvest plot
The following code plots the harvest plot for the driving outcome.

To set the colour scheme:
```{r}
cbPalette <- c("#264653","#2a9d8f","#f4a261")
```

We start building the harvest plot, specifying that the colour of each bar is represented by the variable **stat_significant**, the height of each bar by **quality**, the number of interventions is labelled above each bar by **n_interventions**, and the position of each bar by **position**. We then add bars to represent each study.

```{r}
drive_a<- ggplot(drive, aes(fill=stat_sig, y=quality, x=position, label = study_id)) + 
  geom_bar(position="dodge", stat="identity") +
  facet_grid(cols = vars(direction_effect)) +
  scale_fill_manual(values=cbPalette, na.translate=FALSE) +
  geom_text(aes(label=n_interventions), position=position_dodge(width=0.9), vjust=-0.4)
``` 

Next, we use the facetgrid function to specify that we want **cs_category** as our rows and **direction_effect** as our columns.
```{r}
drive_b<- drive_a + facet_grid(cs_category~direction_effect,  
   switch = "y", space='free_x') + theme_minimal(base_size = 14) 
```   

The following code formats the figure so it's easier to distinguish between the different rows and columns:
```{r} 
drive_c <- drive_b +  theme(strip.placement = "outside")+ scale_y_continuous("", limits=c(0,3.5)) +
  theme(plot.title = element_text(size = 14, face = "bold"),
        legend.title=element_text(size=12,  face = "bold"), 
        legend.text=element_text(size=10)) +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf) +
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank())
```

Specifying the title and legends:
```{r} 
drive_final <- drive_c + guides(fill = guide_legend("Significant", nrow = 3)) +
  theme(legend.position="right") + labs(title="Driving") 
```

The final plot should look like this:
```{r, fig.width=10,fig.height=6, warning=FALSE}
drive_final
```
<br><br>

***
### Public transport harvest plot
Repeat the steps above for the public transport outcomes, as below:

```{r}
pt_final<- ggplot(public_transport, aes(fill=stat_sig, y=quality, x=position, label = study_id)) + 
  geom_bar(position="dodge", stat="identity") + scale_fill_manual(values=cbPalette, na.translate=FALSE) +
  geom_text(aes(label=n_interventions), position=position_dodge(width=0.9), vjust=-0.4) +
  facet_grid(cs_category~direction_effect,  
   switch = "y", space='free_x') + theme_minimal(base_size = 12) +
  theme(strip.placement = "outside")+ scale_y_continuous("", limits=c(0,3.5)) +
  theme(plot.title = element_text(size = 14, face = "bold"),
        legend.title=element_text(size=12,  face = "bold"), 
        legend.text=element_text(size=10)) +
  annotate("segment", x=-Inf, xend=Inf, y=-Inf, yend=-Inf)+
  annotate("segment", x=-Inf, xend=-Inf, y=-Inf, yend=Inf) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank()) +
  guides(fill = guide_legend("Significant", nrow = 3)) +
  theme(legend.position="right") + labs(title="Public transport")
``` 


The final plot should look like this:
```{r, fig.width=10,fig.height=6, warning=FALSE}
pt_final
```
<br><br>

***

## Creating the final combined harvest plot
We then use the ggarrange function to plot both the Driving and Public transport harvest plot figures together:
```{r, fig.width=10,fig.height=12}
figure <- ggarrange(drive_final, pt_final, hjust = -0.5,
                    ncol = 1, nrow = 2)
figure
```